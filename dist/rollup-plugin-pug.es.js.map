{"version":3,"file":"rollup-plugin-pug.es.js","sources":["../src/make-filter.js","../src/assign.js","../src/index.js"],"sourcesContent":["import { createFilter } from 'rollup-pluginutils'\nimport { extname } from 'path'\n\n/**\n * Creates a filter for the options `include`, `exclude`, and `extensions`.\n * It filter out names starting with `\\0`.\n * Since `extensions` is not a rollup option, I think is widely used.\n *\n * @param {object}       opts - The user options\n * @param {array|string} exts - Default extensions\n * @returns {function}   Filter function that returns true if a given\n *                       file matches the filter.\n */\nexport default function makeFilter (opts, exts) {\n  if (!opts) opts = {}\n\n  const filt = createFilter(opts.include, opts.exclude)\n\n  exts = opts.extensions || exts || '*'\n  if (exts !== '*') {\n    if (!Array.isArray(exts)) exts = [exts]\n    exts = exts.map((e) => { return e[0] !== '.' ? `.${e}` : e })\n  }\n\n  return function (id) {\n    return filt(id) && (exts === '*' || exts.indexOf(extname(id)) > -1)\n  }\n}\n","/**\n * Object.assign like function, but converts falsy `dest` to object.\n *\n * @param   {any} dest - An object or falsy value\n * @returns {Object}   object with merged properties\n */\nexport default function assign (dest) {\n  const args = arguments\n\n  dest = dest && Object(dest) || {}\n\n  for (let i = 1; i < args.length; i++) {\n    const src = args[i]\n\n    if (src) {\n      const keys = Object.keys(Object(src))\n\n      for (let j = 0; j < keys.length; j++) {\n        const p = keys[j]\n\n        dest[p] = src[p]\n      }\n    }\n  }\n\n  return dest\n}\n","import { compile, compileClientWithDependenciesTracked } from 'pug'\nimport { resolve, dirname } from 'path'\nimport genPugSourceMap from 'gen-pug-source-map'\nimport makeFilter from './make-filter'\nimport assign from './assign'\n\n// used pug options, note this list does not include 'name'\nconst PUGPROPS = [\n  'filename', 'basedir', 'doctype', 'pretty', 'filters', 'self',\n  'debug', 'compileDebug', 'globals', 'inlineRuntimeFunctions'\n]\n\n// perform a deep cloning of an object\nfunction clone (obj) {\n  if (obj == null || typeof obj != 'object') return obj\n  const copy = obj.constructor()\n  for (const attr in obj) {\n    if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr])\n  }\n  return copy\n}\n\n// deep copy of the properties filtered by list\nfunction cloneProps (src, list) {\n  return list.reduce((o, p) => {\n    if (p in src) o[p] = clone(src[p])\n    return o\n  }, {})\n}\n\n// rollup-plugin-pug --------------------------------------\n\nexport default function pugPlugin (options) {\n  if (!options) options = {}\n\n  // prepare extensions to match with the extname() result\n  const filter = makeFilter(options, ['.pug', '.jade'])\n\n  // shallow copy options & drop properties unused props\n  const config = assign({\n    doctype: 'html',\n    compileDebug: false,\n    staticPattern: /\\.static\\.(?:pug|jade)$/,\n    locals: {}\n  }, options)\n\n  config.inlineRuntimeFunctions = false\n  config.pugRuntime = resolve(__dirname, 'runtime.es.js')\n  config.sourceMap  = config.sourceMap !== false\n\n  // v1.0.3 add default globals to the user defined set\n  const globals = ['String', 'Number', 'Boolean', 'Date', 'Array', 'Function', 'Math', 'RegExp']\n\n  if (config.globals) {\n    config.globals.forEach(g => { if (globals.indexOf(g) < 0) globals.push(g) })\n  }\n  config.globals = globals\n\n  function matchStaticPattern (file) {\n    return config.staticPattern && config.staticPattern.test(file)\n  }\n\n  return {\n\n    name: 'rollup-plugin-pug',\n\n    options (opts) {\n      if (!config.basedir) {\n        config.basedir = dirname(resolve(opts.entry || '~'))\n      }\n    },\n\n    resolveId (importee) {\n      if (/\\0pug-runtime$/.test(importee)) return config.pugRuntime\n    },\n\n    transform (code, id) {\n      if (!filter(id)) {\n        return null\n      }\n\n      const opts   = cloneProps(config, PUGPROPS)\n      const output = []\n\n      let fn, body, map, keepDbg\n\n      opts.filename = id\n\n      if (matchStaticPattern(id)) {\n\n        // v1.0.3: include compiler options in locals as \"options\"\n        const locals = config.locals\n        locals._pug_options = assign({}, config)\n        delete locals._pug_options.locals\n\n        fn = compile(code, opts)\n        body = JSON.stringify(fn(locals)) + ';'\n\n      } else {\n\n        keepDbg = opts.compileDebug\n        if (config.sourceMap) opts.compileDebug = map = true\n\n        fn = compileClientWithDependenciesTracked(code, opts)\n        body = fn.body.replace('function template(', 'function(')\n\n        if (/\\bpug\\./.test(body)) {\n          output.push(\"import pug from '\\0pug-runtime';\")\n        }\n      }\n\n      const deps = fn.dependencies\n      if (deps.length > 1) {\n        const ins = {}\n\n        deps.forEach((dep) => {\n          if (dep in ins) return\n          ins[dep] = output.push(`import '${dep}';`)\n        })\n      }\n\n      output.push(`export default ${body}`)\n\n      body = output.join('\\n') + '\\n'\n\n      if (map) {\n        const bundle = genPugSourceMap(id, body, {\n          basedir: opts.basedir,\n          keepDebugLines: keepDbg\n        })\n        return { code: bundle.data, map: bundle.map }\n      }\n\n      return body\n    }\n  }\n}\n"],"names":["const","let"],"mappings":"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"}
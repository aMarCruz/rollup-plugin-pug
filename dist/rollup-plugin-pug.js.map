{"version":3,"file":"rollup-plugin-pug.js","sources":["../src/get-runtime.js","../src/move-imports.js","../src/utils/clone.js","../src/clone-pug-opts.js","../src/utils/make-filter.js","../src/utils/assign.js","../src/index.js"],"sourcesContent":["import { resolve } from 'path'\n\nexport default function (config) {\n  let runtime = config.inlineRuntimeFunctions ? false : config.pugRuntime\n\n  if (runtime === false) {\n    config.runtimeImport = ''\n    runtime = ''\n\n  } else if (typeof runtime != 'string') {\n    config.runtimeImport = '\\0pug-runtime'\n    runtime = resolve(__dirname, 'runtime.es.js')\n\n  } else {\n    config.runtimeImport = runtime\n    runtime = ''\n  }\n\n  return runtime\n}\n","const RE_IMPORTS = /^([ \\t]*-)[ \\t]*(import[ \\t*{'\"].*)/gm\n\nexport default function (code, imports) {\n\n  return code.replace(RE_IMPORTS, function (_, indent, _import) {\n    _import = _import.trim()\n    if (_import.slice(-1) !== ';') _import += ';'\n    imports.push(_import)\n    return indent\n  })\n\n}\n","/**\n * Perform a deep cloning of an object (enumerable properties).\n *\n * @param {any} obj - The object to clone\n * @returns {object} A new object.\n */\nexport default function clone (obj) {\n\n  if (obj == null || typeof obj != 'object') {\n    return obj  // not an object, return as is\n  }\n\n  const copy = obj.constructor()\n\n  for (const attr in obj) {\n    if (obj.hasOwnProperty(attr)) {\n      copy[attr] = clone(obj[attr])\n    }\n  }\n\n  return copy\n}\n","import clone from './utils/clone'\n\n// used pug options, note this list does not include 'cache' and 'name'\nconst PUGPROPS = [\n  'filename', 'basedir', 'doctype', 'pretty', 'filters', 'self',\n  'debug', 'compileDebug', 'globals', 'inlineRuntimeFunctions'\n]\n\n// deep copy of the properties filtered by list\nexport default function (src) {\n\n  return PUGPROPS.reduce((o, p) => {\n    if (p in src) o[p] = clone(src[p])\n    return o\n  }, {})\n\n}\n","import { createFilter } from 'rollup-pluginutils'\nimport { extname } from 'path'\n\n/**\n * Creates a filter for the options `include`, `exclude`, and `extensions`.\n * It filter out names starting with `\\0`.\n * Since `extensions` is not a rollup option, I think is widely used.\n *\n * @param {object}       opts - The user options\n * @param {array|string} exts - Default extensions\n * @returns {function}   Filter function that returns true if a given\n *                       file matches the filter.\n */\nexport default function makeFilter (opts, exts) {\n  if (!opts) opts = {}\n\n  const filt = createFilter(opts.include, opts.exclude)\n\n  exts = opts.extensions || exts\n\n  if (!exts || exts === '*') {\n    return filt\n  }\n\n  if (!Array.isArray(exts)) exts = [exts]\n  exts = exts.map((e) => { return e[0] !== '.' ? `.${e}` : e })\n\n  return function (id) {\n    return filt(id) && exts.indexOf(extname(id)) > -1\n  }\n}\n","/**\n * Object.assign like function, but always converts falsy `dest` to object.\n *\n * @param   {any} dest - An object or falsy value\n * @returns {Object}   object with merged properties\n */\nexport default function assign (dest) {\n  const args = arguments\n\n  dest = dest ? Object(dest) : {}\n\n  for (let i = 1; i < args.length; i++) {\n    const src = args[i]\n\n    if (src) {\n      const keys = Object.keys(src)\n\n      for (let j = 0; j < keys.length; j++) {\n        const p = keys[j]\n\n        dest[p] = src[p]\n      }\n    }\n  }\n\n  return dest\n}\n","import { render, compileClientWithDependenciesTracked } from 'pug'\nimport { resolve, dirname } from 'path'\nimport genPugSourceMap from 'gen-pug-source-map'\nimport getRuntime from './get-runtime'\nimport moveImports from './move-imports'\nimport clonePugOpts from './clone-pug-opts'\nimport makeFilter from './utils/make-filter'\nimport assign from './utils/assign'\nimport clone from './utils/clone'\n\n// rollup-plugin-pug --------------------------------------\n\nexport default function pugPlugin (options) {\n\n  // prepare extensions to match with the extname() result\n  const filter = makeFilter(options, ['.pug', '.jade'])\n\n  // shallow copy options & drop properties unused props\n  const config = assign({\n    doctype: 'html',\n    compileDebug: false,\n    staticPattern: /\\.static\\.(?:pug|jade)$/,\n    inlineRuntimeFunctions: false,\n    locals: {}\n  }, options)\n\n  config.pugRuntime = getRuntime(config)\n  config.sourceMap  = config.sourceMap !== false\n\n  // v1.0.3 add default globals to the user defined set\n  const globals = ['String', 'Number', 'Boolean', 'Date', 'Array', 'Function', 'Math', 'RegExp']\n\n  if (config.globals) {\n    config.globals.forEach(g => { if (globals.indexOf(g) < 0) globals.push(g) })\n  }\n  config.globals = globals\n\n  function matchStaticPattern (file) {\n    return config.staticPattern && config.staticPattern.test(file)\n  }\n\n  return {\n\n    name: 'rollup-plugin-pug',\n\n    options (opts) {\n      if (!config.basedir) {\n        config.basedir = dirname(resolve(opts.entry || './'))\n      }\n    },\n\n    resolveId (importee) {\n      if (importee === config.runtimeImport && config.pugRuntime) {\n        return config.pugRuntime\n      }\n    },\n\n    transform (code, id) {\n      if (!filter(id)) {\n        return null\n      }\n\n      const is_static = matchStaticPattern(id)\n      let opts\n\n      if (is_static) {\n        opts = clone(config)\n      } else {\n        opts = clonePugOpts(config)\n      }\n\n      const output = []\n      let fn, body, map, keepDbg\n\n      opts.filename = id\n\n      if (is_static) {\n        const static_opts = assign(null, config.locals, opts)\n\n        body = `export default ${JSON.stringify(render(code, static_opts))};`\n\n      } else {\n        keepDbg = opts.compileDebug\n        if (config.sourceMap) {\n          opts.compileDebug = map = true\n        }\n        code = moveImports(code, output)\n\n        fn = compileClientWithDependenciesTracked(code, opts)\n        body = fn.body.replace('function template(', '\\nexport default function(')\n\n        if (config.runtimeImport && /\\bpug\\./.test(body)) {\n          output.unshift(`import pug from '${config.runtimeImport}';`)\n        }\n\n        const deps = fn.dependencies\n        if (deps.length) {\n          const ins = {}\n\n          deps.forEach((dep) => {\n            if (dep in ins) return\n            ins[dep] = output.push(`import '${dep}';`)\n          })\n        }\n      }\n\n      output.push(body)\n\n      body = output.join('\\n') + ';\\n'\n\n      if (map) {\n        const bundle = genPugSourceMap(id, body, {\n          basedir: opts.basedir,\n          keepDebugLines: keepDbg\n        })\n        return { code: bundle.data, map: bundle.map }\n      }\n\n      return body\n    }\n  }\n}\n"],"names":["let","resolve","const","createFilter","extname","dirname","render","compileClientWithDependenciesTracked"],"mappings":";;;;;;;AAEA,iBAAe,UAAU,MAAM,EAAE;EAC/BA,IAAI,OAAO,GAAG,MAAM,CAAC,sBAAsB,GAAG,KAAK,GAAG,MAAM,CAAC,UAAU,CAAA;;EAEvE,IAAI,OAAO,KAAK,KAAK,EAAE;IACrB,MAAM,CAAC,aAAa,GAAG,EAAE,CAAA;IACzB,OAAO,GAAG,EAAE,CAAA;;GAEb,MAAM,IAAI,OAAO,OAAO,IAAI,QAAQ,EAAE;IACrC,MAAM,CAAC,aAAa,GAAG,eAAe,CAAA;IACtC,OAAO,GAAGC,YAAO,CAAC,SAAS,EAAE,eAAe,CAAC,CAAA;;GAE9C,MAAM;IACL,MAAM,CAAC,aAAa,GAAG,OAAO,CAAA;IAC9B,OAAO,GAAG,EAAE,CAAA;GACb;;EAED,OAAO,OAAO;CACf,CAAA;;ACnBDC,IAAM,UAAU,GAAG,uCAAuC,CAAA;;AAE1D,kBAAe,UAAU,IAAI,EAAE,OAAO,EAAE;;EAEtC,OAAO,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,UAAU,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE;IAC5D,OAAO,GAAG,OAAO,CAAC,IAAI,EAAE,CAAA;IACxB,IAAI,OAAO,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE,EAAA,OAAO,IAAI,GAAG,CAAA,EAAA;IAC7C,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAA;IACrB,OAAO,MAAM;GACd,CAAC;;CAEH,CAAA;;ACXD;;;;;;AAMA,AAAe,SAAS,KAAK,EAAE,GAAG,EAAE;;EAElC,IAAI,GAAG,IAAI,IAAI,IAAI,OAAO,GAAG,IAAI,QAAQ,EAAE;IACzC,OAAO,GAAG;GACX;;EAEDA,IAAM,IAAI,GAAG,GAAG,CAAC,WAAW,EAAE,CAAA;;EAE9B,KAAKA,IAAM,IAAI,IAAI,GAAG,EAAE;IACtB,IAAI,GAAG,CAAC,cAAc,CAAC,IAAI,CAAC,EAAE;MAC5B,IAAI,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAA;KAC9B;GACF;;EAED,OAAO,IAAI;CACZ;;;AClBDA,IAAM,QAAQ,GAAG;EACf,UAAU,EAAE,SAAS,EAAE,SAAS,EAAE,QAAQ,EAAE,SAAS,EAAE,MAAM;EAC7D,OAAO,EAAE,cAAc,EAAE,SAAS,EAAE,wBAAwB;CAC7D,CAAA;;;AAGD,mBAAe,UAAU,GAAG,EAAE;;EAE5B,OAAO,QAAQ,CAAC,MAAM,CAAC,UAAC,CAAC,EAAE,CAAC,EAAE;IAC5B,IAAI,CAAC,IAAI,GAAG,EAAE,EAAA,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAA,EAAA;IAClC,OAAO,CAAC;GACT,EAAE,EAAE,CAAC;;CAEP,CAAA;;;;;;;;;;;;ACHD,AAAe,SAAS,UAAU,EAAE,IAAI,EAAE,IAAI,EAAE;EAC9C,IAAI,CAAC,IAAI,EAAE,EAAA,IAAI,GAAG,EAAE,CAAA,EAAA;;EAEpBA,IAAM,IAAI,GAAGC,8BAAY,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,CAAA;;EAErD,IAAI,GAAG,IAAI,CAAC,UAAU,IAAI,IAAI,CAAA;;EAE9B,IAAI,CAAC,IAAI,IAAI,IAAI,KAAK,GAAG,EAAE;IACzB,OAAO,IAAI;GACZ;;EAED,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,EAAA,IAAI,GAAG,CAAC,IAAI,CAAC,CAAA,EAAA;EACvC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,UAAC,CAAC,EAAE,EAAK,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,IAAG,GAAE,GAAE,CAAC,IAAK,CAAC,EAAE,CAAC,CAAA;;EAE7D,OAAO,UAAU,EAAE,EAAE;IACnB,OAAO,IAAI,CAAC,EAAE,CAAC,IAAI,IAAI,CAAC,OAAO,CAACC,YAAO,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC;GAClD;CACF;;AC9BD;;;;;;AAMA,AAAe,SAAS,MAAM,EAAE,IAAI,EAAE;EACpCF,IAAM,IAAI,GAAG,SAAS,CAAA;;EAEtB,IAAI,GAAG,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,CAAA;;EAE/B,KAAKF,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;IACpCE,IAAM,GAAG,GAAG,IAAI,CAAC,CAAC,CAAC,CAAA;;IAEnB,IAAI,GAAG,EAAE;MACPA,IAAM,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;;MAE7B,KAAKF,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;QACpCE,IAAM,CAAC,GAAG,IAAI,CAAC,CAAC,CAAC,CAAA;;QAEjB,IAAI,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;OACjB;KACF;GACF;;EAED,OAAO,IAAI;CACZ;;;;ACdD,AAAe,SAAS,SAAS,EAAE,OAAO,EAAE;;;EAG1CA,IAAM,MAAM,GAAG,UAAU,CAAC,OAAO,EAAE,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC,CAAA;;;EAGrDA,IAAM,MAAM,GAAG,MAAM,CAAC;IACpB,OAAO,EAAE,MAAM;IACf,YAAY,EAAE,KAAK;IACnB,aAAa,EAAE,yBAAyB;IACxC,sBAAsB,EAAE,KAAK;IAC7B,MAAM,EAAE,EAAE;GACX,EAAE,OAAO,CAAC,CAAA;;EAEX,MAAM,CAAC,UAAU,GAAG,UAAU,CAAC,MAAM,CAAC,CAAA;EACtC,MAAM,CAAC,SAAS,IAAI,MAAM,CAAC,SAAS,KAAK,KAAK,CAAA;;;EAG9CA,IAAM,OAAO,GAAG,CAAC,QAAQ,EAAE,QAAQ,EAAE,SAAS,EAAE,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAA;;EAE9F,IAAI,MAAM,CAAC,OAAO,EAAE;IAClB,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,UAAA,CAAC,EAAC,EAAK,IAAI,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,EAAE,EAAA,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA,EAAA,EAAE,CAAC,CAAA;GAC7E;EACD,MAAM,CAAC,OAAO,GAAG,OAAO,CAAA;;EAExB,SAAS,kBAAkB,EAAE,IAAI,EAAE;IACjC,OAAO,MAAM,CAAC,aAAa,IAAI,MAAM,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC;GAC/D;;EAED,OAAO;;IAEL,IAAI,EAAE,mBAAmB;;IAEzB,OAAO,kBAAA,EAAE,IAAI,EAAE;MACb,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE;QACnB,MAAM,CAAC,OAAO,GAAGG,YAAO,CAACJ,YAAO,CAAC,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC,CAAC,CAAA;OACtD;KACF;;IAED,SAAS,oBAAA,EAAE,QAAQ,EAAE;MACnB,IAAI,QAAQ,KAAK,MAAM,CAAC,aAAa,IAAI,MAAM,CAAC,UAAU,EAAE;QAC1D,OAAO,MAAM,CAAC,UAAU;OACzB;KACF;;IAED,SAAS,oBAAA,EAAE,IAAI,EAAE,EAAE,EAAE;MACnB,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE;QACf,OAAO,IAAI;OACZ;;MAEDC,IAAM,SAAS,GAAG,kBAAkB,CAAC,EAAE,CAAC,CAAA;MACxCF,IAAI,IAAI,CAAA;;MAER,IAAI,SAAS,EAAE;QACb,IAAI,GAAG,KAAK,CAAC,MAAM,CAAC,CAAA;OACrB,MAAM;QACL,IAAI,GAAG,YAAY,CAAC,MAAM,CAAC,CAAA;OAC5B;;MAEDE,IAAM,MAAM,GAAG,EAAE,CAAA;MACjBF,IAAI,EAAE,EAAE,IAAI,EAAE,GAAG,EAAE,OAAO,CAAA;;MAE1B,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAA;;MAElB,IAAI,SAAS,EAAE;QACbE,IAAM,WAAW,GAAG,MAAM,CAAC,IAAI,EAAE,MAAM,CAAC,MAAM,EAAE,IAAI,CAAC,CAAA;;QAErD,IAAI,GAAG,iBAAgB,IAAE,IAAI,CAAC,SAAS,CAACI,UAAM,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC,CAAA,MAAE,CAAA;;OAErE,MAAM;QACL,OAAO,GAAG,IAAI,CAAC,YAAY,CAAA;QAC3B,IAAI,MAAM,CAAC,SAAS,EAAE;UACpB,IAAI,CAAC,YAAY,GAAG,GAAG,GAAG,IAAI,CAAA;SAC/B;QACD,IAAI,GAAG,WAAW,CAAC,IAAI,EAAE,MAAM,CAAC,CAAA;;QAEhC,EAAE,GAAGC,wCAAoC,CAAC,IAAI,EAAE,IAAI,CAAC,CAAA;QACrD,IAAI,GAAG,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,oBAAoB,EAAE,4BAA4B,CAAC,CAAA;;QAE1E,IAAI,MAAM,CAAC,aAAa,IAAI,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;UAChD,MAAM,CAAC,OAAO,EAAC,mBAAkB,IAAE,MAAM,CAAC,aAAa,CAAA,OAAG,EAAE,CAAA;SAC7D;;QAEDL,IAAM,IAAI,GAAG,EAAE,CAAC,YAAY,CAAA;QAC5B,IAAI,IAAI,CAAC,MAAM,EAAE;UACfA,IAAM,GAAG,GAAG,EAAE,CAAA;;UAEd,IAAI,CAAC,OAAO,CAAC,UAAC,GAAG,EAAE;YACjB,IAAI,GAAG,IAAI,GAAG,EAAE,EAAA,MAAM,EAAA;YACtB,GAAG,CAAC,GAAG,CAAC,GAAG,MAAM,CAAC,IAAI,EAAC,UAAS,GAAE,GAAG,OAAG,EAAE,CAAA;WAC3C,CAAC,CAAA;SACH;OACF;;MAED,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;;MAEjB,IAAI,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,KAAK,CAAA;;MAEhC,IAAI,GAAG,EAAE;QACPA,IAAM,MAAM,GAAG,eAAe,CAAC,EAAE,EAAE,IAAI,EAAE;UACvC,OAAO,EAAE,IAAI,CAAC,OAAO;UACrB,cAAc,EAAE,OAAO;SACxB,CAAC,CAAA;QACF,OAAO,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,EAAE,GAAG,EAAE,MAAM,CAAC,GAAG,EAAE;OAC9C;;MAED,OAAO,IAAI;KACZ;GACF;CACF;;"}